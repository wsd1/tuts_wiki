<!DOCTYPE html>



<html>

<head>

	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

	<title>My ExMem wiki</title>

	<link rel="shortcut icon" href="/static/img/favicon.ico" type="image/x-icon" />
	<!-- 新 Bootstrap 核心 CSS 文件 -->
	<link rel="stylesheet" href="/static/css/bootstrap.min.css">
	<!-- 可选的Bootstrap主题文件（一般不用引入） -->
	<link rel="stylesheet" href="/static/css/bootstrap-theme.min.css">


	<link rel="stylesheet" href="//cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">

	<style type="text/css">
		.bs-docs-footer {
			padding-top: 40px;
			padding-bottom: 40px;
			margin-top: 100px;
			color: #767676;
			text-align: center;
			border-top: 1px solid #e5e5e5;
		}
		.bs-docs-footer-links {
			padding-left: 0;
			margin-top: 20px;
		}
		.bs-docs-footer-links li:first-child {
			padding-left: 0;
		}
		.bs-docs-footer-links li {
			display: inline;
			padding: 0 2px;
		}

		.CodeMirror, .CodeMirror-scroll {
			min-height: 300px;
			max-height: 600px;
		}

	</style>
</head>

<body>
		<nav class="navbar navbar-default">
			<div class="container-fluid">
				<div class="navbar-header">

					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">

						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>

					<a class="navbar-brand" href="/">{{.Website}}</a>
				</div>


				<div id="navbar" class="navbar-collapse collapse">

					<ul class="nav navbar-nav navbar-right">
						<li><a href="/login?exit=true">Logout</a></li>
					</ul>

					<!--form class="navbar-form navbar-right">
						<div class="form-group">
							<input type="text" placeholder="Email" class="form-control">
						</div>
						<div class="form-group">
							<input type="password" placeholder="Password" class="form-control">
						</div>
						<button type="submit" class="btn btn-success">Sign in</button>
					</form-->

				</div><!--/.navbar-collapse -->
			</div>
		</nav>



		<div class="container-fluid">
			<div class="row">
				<div class="col-xs-8 col-md-2">

					<!--div class="panel panel-default">
						<div class="panel-heading">
							<div class="input-group">
								<input type="text" class="form-control" placeholder="Search for...">
								<span class="input-group-btn">
									<button class="btn btn-default" type="button">Go!</button>
								</span>
							</div>
						</div>
						
						<div class="panel-body list-group">
							<a href="#" class="list-group-item">Addon</a>
						</div>
					</div-->


					<!--div class="panel panel-default">
						<div class="panel-heading">
							<span class="glyphicon glyphicon-log-in" aria-hidden="true"></span>
							Be involved
						</div>

						<div class="panel-body list-group">
							{{range .BeInvolved}}
							<a href="/words/{{.}}" class="list-group-item">{{.}}</a>
							{{end}}
						</div>

					</div-->



				</div>
				<div class="col-xs-12 col-md-8">


					<ol class="breadcrumb" >
						{{range .WordPath}}
						<li>
							{{if eq $.WordCurrent .}}
							{{.}}
							{{else}}
							<a href="/words/{{.}}">{{.}}</a>
							{{end}}
						</li>
						{{end}}
					</ol>

					<!--ul class="nav nav-pills navbar-right" role="tablist" id="tab-list" style="margin-top: -4px;">
						<li class="active"><a href="#view" role="tab" data-toggle="tab"><span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span>view</a></li>
						<li><a href="#source" role="tab" data-toggle="tab"><span class="glyphicon glyphicon-edit" aria-hidden="true"></span>source</a></li>
					</ul>
					<div class="tab-content">
						<div class="tab-pane active" id="view"></div>
						<div class="tab-pane" id="source"></div>
					</div-->


					<div class="page-header">



						<h1>{{.WordCurrent}}<span id="changed_sign">*</span></h1>
						<span class="label label-info">Create:{{utc2str .WordCreate}}</span>
						<span class="label label-info">Modify:{{utc2str .WordModify}}</span>

						<!--div id='preview'>{{.WordStruct.Cotent}}</div-->
						<div style="margin-top:20px">
							<textarea id='content_editor' >{{.WordContent}}</textarea>
						</div>

						<div class="panel panel-default" style="margin-top:20px">
							<div class="panel-body">
								<p> <span class="glyphicon glyphicon-log-in" aria-hidden="true">
									{{range .BeInvolved}}<a style="line-height:1.5em" href="/words/{{.}}">[{{.}}]</a>{{end}}
								</p>
								<p> <span class="glyphicon glyphicon-tags" aria-hidden="true">
									{{range .Involved}}<a style="line-height:1.5em" href="/words/{{.}}">[{{.}}]</a>{{end}}
								</p>
							</div>
						</div>

					</div>

				</div>

				<div class="col-xs-12 col-md-2">


						<!--table class="table">
							<caption></caption>
							<thead>
								<tr>
									<th>#</th>
									<th>Attribute</th>
									<th>Value</th>
								</tr>
							</thead>

							<tbody>
								{{range .WordAttrs}}
								<tr>
									<th scope="row">1</th>
									<td>{{.Key}}</td>
									<td>{{.Value}}</td>
								</tr>
								{{end}}

							</tbody>
						</table-->

				</div>
			</div>
		</div>

	</div>


			<!-- Footer

	================================================== -->

	<footer class="bs-docs-footer" role="contentinfo">
		<div class="container">
			<p>Designed and built with passion by Dingyi</p>
			<ul class="bs-docs-footer-links text-muted">
				<li>当前版本： V{{.Version}}</li>
				<li>&middot;</li>
				<li><a href="https://github.com/wsd1/tuts_wiki">GitHub</a></li>
			</ul>
		</div>
	</footer>

</body>

	<script src="//cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
	<!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
	<script src="/static/js/jquery-1.11.3.min.js"></script>
	<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
	<script src="/static/js/bootstrap.min.js"></script>


	<script type="text/javascript">

		var tpl_is_new = {{.isNew}}
		var tpl_word_current = {{.WordCurrent}}

		$(document).ready(function(){
		});


		var glb_editor = new SimpleMDE({
			element:document.getElementById("content_editor"),
			indentWithTabs: true,
			tabSize: 4,
			autofocus: true,
			autosave: {
				enabled: true,
				unique_id: {{.WordCurrent}},
				delay: 5000,
			},
			spellChecker: false,

			toolbar: [	"bold", "italic", "heading", "|", 
						"quote", "unordered-list", "ordered-list", "|", 
						"link", "image", "|", 
						"preview", "side-by-side", "fullscreen", 
						//"guide",
						"|",
						{
							name: "save",
							action: saveContent,
							className: "fa fa-save",
							title: "Save (Ctrl+S)",
						},
						{
							name: "relation",
							action: createRelation,
							className: "fa fa-share-alt-square",
							title: "Relation",
						}, "|",
						{
							name: "delete",
							action: deleteSelf,
							className: "fa fa-remove",
							title: "Delete",
						}
					]

		});



		glb_editor.render();

/*
		var glb_editor = CodeMirror.fromTextArea(
			document.getElementById("content_editor"), 
			{
				lineNumbers: false,
				matchBrackets: true,
				theme: "default",
				styleActiveLine: true,
				lineWrapping: true,
	//			mode: "text/x-markdown",
				extraKeys:{
					"Ctrl-R": function() {},
					"Ctrl-S": save_to_svr
				}
			}
		);


*/
		var glb_original_content = document.getElementById("content_editor").value;
//		var glb_original_content = glb_editor.value();

		function is_content_change(editor){
			return glb_original_content != editor.value();
		}

		function on_change(){
			if(is_content_change(glb_editor))
				$("#changed_sign").show();
			else 
				$("#changed_sign").hide();
		}

		on_change();	//Changes may be loaded from local storage.

		glb_editor.codemirror.on('change', on_change);

		
		if(!tpl_is_new){
			glb_editor.togglePreview()
		}		


		function createRelation (editor) {
			var cm = editor.codemirror;

			var startPoint = cm.getCursor('start');
			var endPoint = cm.getCursor('end');

			text = cm.getSelection();
			cm.replaceSelection('[' + text + '](/words/' + text + ')');

			//startPoint.ch += 1;
			//endPoint.ch += 1;
			//cm.setSelection(startPoint, endPoint);

			cm.focus();
		}


		function saveContent(editor) {
			if(!is_content_change(editor))
				return;

			var wiki_word = {
				Word: tpl_word_current,
				Content: editor.value(),
				Compression: false,
				Encryption: false,
				Created: 0,
				Modified: 0,
				Visited: 0,
				Readonly: false
			};

			glb_original_content = wiki_word.Content

			var submit_method, submit_target;

			if(tpl_is_new){
				submit_method = "POST"
				submit_target = "/words"
			}else{
				submit_method = "PUT"
				submit_target = "/words/" + wiki_word.Word
			}
			$.ajax({ 
				type: submit_method, 
				url: submit_target, 
				data: JSON.stringify(wiki_word), 
				contentType: "application/json; charset=utf-8", 
				dataType: "json", 
				success: function (data) {
					$("#changed_sign").hide();
				}, 
				error: function (msg) { 
					alert( msg.statusText );
				} 
			});
		}


		function deleteSelf(editor) {
			if (confirm("Be true to delete!") != true) {
				return;
			}

			$.ajax({ 
				type: "DELETE", 
				url: "/words/" + tpl_word_current, 
				dataType: "json", 
				success: function (data) {
					eval("var ret = " + data);
					window.location = "/words/" + ret.Word
				}, 
				error: function (msg) { 
					alert( msg.statusText );
				} 
			});
		}



	</script>



</html>



